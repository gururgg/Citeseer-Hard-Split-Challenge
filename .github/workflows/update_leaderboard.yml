name: Update Leaderboard

on:
  push:
    branches:
      - main
    paths:
      - 'submissions/*.csv'

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      PRIVATE_Y: ${{ secrets.LABELS }}
      PRIVATE_TEST_MASK_CHALLENGE: ${{ secrets.TEST_MASK_CHALLENGE }}
      PRIVATE_TEST_MASK: ${{ secrets.TEST_MASK }}

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - run: pip install -r requirements.txt

    ############################################################
    # DETECT SUBMISSION FILE
    ############################################################

    - name: Detect submission
      id: detect
      run: |
        FILE=$(git diff --name-only HEAD~1 HEAD | grep '^submissions/.*\.csv$')
        USER=$(basename "$FILE" .csv)

        echo "file=$FILE" >> $GITHUB_OUTPUT
        echo "username=$USER" >> $GITHUB_OUTPUT

    ############################################################
    # EVALUATE
    ############################################################

    - name: Evaluate
      run: |
        FILE="${{ steps.detect.outputs.file }}"
        USER="${{ steps.detect.outputs.username }}"

        python scoring_script.py "$FILE" --json > score.json
        python scripts/update_leaderboard_from_scores.py "$USER" score.json

    ############################################################
    # REMOVE SUBMISSION FILE
    ############################################################

    - name: Remove CSV
      run: |
        rm -f submissions/*.csv

    ############################################################
    # REGENERATE HTML
    ############################################################

    - name: Generate HTML
      run: |
        python scripts/generate_leaderboard.py

    ############################################################
    # COMMIT
    ############################################################

    - name: Commit leaderboard
      run: |
        git config user.name "GitHub Action"
        git config user.email "action@github.com"

        git add leaderboard.json leaderboard.html
        git add -u submissions
        git commit -m "Update leaderboard [skip ci]" || echo "Nothing to commit"
        git push
